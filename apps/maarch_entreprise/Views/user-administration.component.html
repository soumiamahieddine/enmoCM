<div class="page-header">
    <h1 *ngIf="!userCreation">{{lang.userModification}} <small>{{user.lastname}} {{user.firstname}}</small></h1>
    <h1 *ngIf="userCreation">{{lang.userCreation}} <small>{{user.lastname}} {{user.firstname}}</small></h1>
</div>
<div *ngIf="loading">
    <i class="fa fa-spinner fa-spin fa-5x" style="margin-left: 50%;margin-top: 16%;font-size: 8em"></i>
</div>
<div *ngIf="!loading" class="container-fluid">
    <div class="container-fluid">
        <md-tab-group (selectChange)="initService()">
            <md-tab label="Informations">    
                <div *ngIf="user.status == 'ABS'" class="text-warning" style="position: absolute;opacity: 0.1;font-size: 120px;transform: rotate(324deg);-webkit-transform: rotate(324deg);margin-left: 35%;margin-top: 90px;">{{user.status}}</div>    
                <div class="col-md-6 col-md-offset-3">
                    <div class="example-sidenav-content">
                        <form class="form-horizontal" (ngSubmit)="onSubmit()" #profileForm="ngForm">
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="pull-left image">
                                        <img src="img/maarch_box.png" class="img-circle avatar" alt="user profile image">
                                    </div>
                                    <div class="input-group">
                                        <!--<span class="input-group-addon"><i class="fa fa-user" aria-hidden="true"></i></span>-->
                                        <md-input-container>
                                            <input mdInput *ngIf="userCreation" type="text" title="{{lang.id}}" name="user_id" [(ngModel)]="user.userId" placeholder="{{lang.id}}"
                                                pattern="^[\w.@-]*$" required>

                                            <input mdInput *ngIf="!userCreation" type="text" title="{{lang.id}}" value="{{user.user_id}}" placeholder="{{lang.id}}" disabled>
                                        </md-input-container>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-5" style="font-weight:bold;">
                                    <md-input-container>
                                        <input mdInput type="text" id="lastname" name="lastname" title="{{lang.lastname}}" placeholder="{{lang.lastname}}" [(ngModel)]="user.lastname"
                                            required>
                                    </md-input-container>
                                </div>
                                <div class="col-sm-5" style="font-weight:bold;">
                                    <md-input-container>
                                        <input mdInput type="text" id="firstname" name="firstname" title="{{lang.firstname}}" placeholder="{{lang.firstname}}" [(ngModel)]="user.firstname"
                                            required>
                                    </md-input-container>
                                </div>
                                <div class="col-sm-2" style="font-style:italic;">
                                    <md-input-container>
                                        <input mdInput type="text" id="initials" name="initials" title="{{lang.initials}}" placeholder="{{lang.initials}}" [(ngModel)]="user.initials">
                                    </md-input-container>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <md-input-container>
                                        <input mdInput type="tel" id="phone" name="phone" title="{{lang.phoneNumber}}" placeholder="{{lang.phoneNumber}}" [(ngModel)]="user.phone"
                                            pattern="^(?:0|\+\d\d?\d?\s?)[1-9]([\.\-\s]?\d\d){4}([\.\-\s]?\d?\d?)$">
                                    </md-input-container>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <md-input-container>
                                        <input mdInput type="email" id="mail" name="mail" title="{{lang.email}}" placeholder="{{lang.email}}" [(ngModel)]="user.mail"
                                            pattern="[^@\s]+@[^@\s]+">
                                    </md-input-container>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <md-input-container>
                                        <input mdInput type="text" id="fingerprint" name="fingerprint" title="{{lang.fingerprint}}" placeholder="{{lang.fingerprint}}"
                                            [(ngModel)]="user.thumbprint">
                                    </md-input-container>
                                </div>
                            </div>
                            <div class="form-group">
                                <div style="text-align:center;">
                                    <button *ngIf="userCreation" type="submit" class="btn btn-success" [disabled]="!profileForm.form.valid"><i class="fa fa-plus"></i> {{lang.save}}</button>
                                    <button *ngIf="!userCreation" type="submit" class="btn btn-success" [disabled]="!profileForm.form.valid"><i class="fa fa-save"></i> {{lang.update}}</button>
                                    <button *ngIf="user.status != 'ABS' && !userCreation" type="button" (click)="activateAbsence()" class="btn btn-warning"><i class="fa fa-plane"></i> {{lang.activateAbsence}}</button>
                                    <button *ngIf="user.status == 'ABS' && !userCreation" type="button" (click)="desactivateAbsence()" class="btn btn-success"><i class="fa fa-check"></i> {{lang.desactivateAbsence}}</button>
                                    <button type="button" *ngIf="!userCreation" (click)="resetPassword()" class="btn btn-default"><i class="fa fa-key"></i> {{lang.reinitPassword}}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </md-tab>
            <md-tab *ngIf="!userCreation" label="Groupe(s)">
                <div class="col-md-6">
                    <div class="groupList">
                        <ul class="list-group col-md-12">
                            <li class="list-group-item" *ngFor="let group of user.allGroups">
                                <md-slide-toggle id="{{group.group_id}}" color="primary" [checked]="group.disabled == true" (change)="toggleGroup(group)">{{group.group_desc}}</md-slide-toggle>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4 col-md-offset-1">
                    <div class="panel" *ngFor="let userGroup of user.groups" [ngClass]="[userGroup.primary_group == 'Y' ? 'panel-primary' : 'panel-default']">
                        <div class="panel-heading">
                            {{userGroup.group_desc}} <i *ngIf="userGroup.primary_group != 'Y'" class="fa fa-asterisk" aria-hidden="true"></i>
                        </div>
                        <div class="panel-body">
                            <md-input-container>
                                <input mdInput type="text" id="role" name="role" title="{{lang.role}}" placeholder="{{lang.role}}" [(ngModel)]="userGroup.role"
                                    (focusout)="updateGroup(userGroup)">
                            </md-input-container>
                            <div class="col-md-12">
                                <ul class="list-unstyled">
                                    <li *ngFor="let basket of user.baskets; let i = index">
                                        <span *ngIf="basket.group_id == userGroup.group_id">
                                            <md-slide-toggle [(ngModel)]="basket.enabled" color="primary">{{basket.basket_name}} <small class="text-danger" style="font-style:italic;" *ngIf="basket.userToDisplay != '' && basket.enabled">(Redirigé à {{basket.userToDisplay}})</small></md-slide-toggle>
                                            <i (click)="toogleRedirect(basket)" *ngIf="basket.userToDisplay == '' && basket.enabled" mdTooltip="Rediriger la banette à une personne lors de l'activation de l'absence" mdTooltipPosition="above"
                                                class="fa fa-share-square text-primary" style="cursor:pointer;"></i>
                                            <sup><i style="cursor:pointer;" *ngIf="basket.userToDisplay != '' && basket.enabled" mdTooltip="Supprimer la redirection" class="fa fa-times text-danger" aria-hidden="true" (click)="delBasketRedirection(i)"></i></sup>
                                            <div *ngIf="basket.userToDisplay == '' && basket.enabled" id="redirectUser_{{basket.group_id}}_{{basket.basket_id}}" class="form-group typeahead__container" style="display:none;">
                                                <div class="typeahead__field">
                                                    <input id="absenceUser_{{basket.group_id}}_{{basket.basket_id}}" type="text" class="form-control" placeholder="{{lang.user}}" autocomplete="off" (change)="addBasketRedirection(i,basket)">
                                                </div>
                                            </div>
                                        </span>

                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <md-input-container>
                                <input value="{{userGroup.maarch_comment}}" mdInput type="text" title="{{lang.perimeter}}" placeholder="Ressource documentaire"
                                    disabled>
                            </md-input-container>
                        </div>
                    </div>
                </div>
            </md-tab>
            <md-tab *ngIf="!userCreation" label="Entité(s)">
                <div class="col-md-6">
                    <div id="jstree"></div>
                </div>
                <div class="col-md-4 col-md-offset-1">
                    <div class="panel" *ngFor="let userEntity of user.entities" [ngClass]="[userEntity.primary_entity == 'Y' ? 'panel-primary' : 'panel-default']">
                        <div class="panel-heading">
                            {{userEntity.entity_label}} <i mdTooltip="Passer en entité primaire" *ngIf="userEntity.primary_entity != 'Y'"
                                (click)="updatePrimaryEntity(userEntity)" class="fa fa-asterisk text-primary pull-right" style="cursor:pointer;"></i>
                        </div>
                        <div class="panel-body">
                            <md-input-container>
                                <input mdInput type="text" id="role" name="role" title="{{lang.role}}" placeholder="{{lang.role}}" [(ngModel)]="userEntity.user_role"
                                    (focusout)="updateEntity(userEntity)">
                            </md-input-container>
                        </div>
                    </div>
                </div>
            </md-tab>
            <md-tab *ngIf="!userCreation" label="Signature(s)">
                <div class="col-md-6 col-md-offset-3">
                    <div class="form-group">
                        <button (click)="clickOnUploader('uploadSignFile')" mdTooltip="taille de 2 mo maximum" class="form-control btn btn-sm btn-success"
                            style="width:auto;">
                                <i class="fa fa-plus"></i> Ajouter une signature
                            </button>
                    </div>
                    <div class="form-group">
                        <div class="row" style="margin-top:5px;display:none;">
                            <form (ngSubmit)="submitSignature()" #signatureForm="ngForm">
                                <div class="col-md-11">
                                    <input type="text" [(ngModel)]="signatureModel.label" id="signLabel" name="label" placeholder="{{lang.label}}" class="form-control"
                                        required>
                                    <div class="form-inline hide">
                                        <div class="form-group">
                                            <input type="file" name="files[]" id="uploadSignFile" (change)="uploadSignatureTrigger($event)" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1" style="margin-bottom:5px;">
                                    <button class="form-control btn btn-sm btn-success" type="submit" [disabled]="!signatureForm.form.valid || !signatureModel.size">
                                                    <i class="fa fa-plus"></i>
                                                </button>
                                </div>
                                <div [ngClass]="[signatureModel.size != '' ? 'col-md-10' : 'col-md-12']">
                                    <div class="upload-drop-zone" (click)="clickOnUploader('uploadSignFile')" style="cursor:pointer">
                                        {{lang.clickOn}} <i class="fa fa-upload fa-2x"></i> (
                                        < 2MB) </div>
                                    </div>
                                    <div class="col-md-2" *ngIf="signatureModel.size">
                                        <img id="signaturePreview" src="{{signatureModel.base64ForJs}}" alt="Invalid image" style="width: 100%;">
                                    </div>
                            </form>
                            </div>
                            <div id="signList">
                                <div *ngFor="let signature of user.signatures; let i = index" class="col-md-4" style="margin-bottom:10px;">
                                    <md-card>
                                        <md-card-header>
                                            <md-card-title>
                                                <md-input-container>
                                                    <input mdInput type="text" [(ngModel)]="signature.signature_label" name="selectedSignatureLabel" placeholder="{{lang.label}}"
                                                        (focusout)="updateSignature(i)">
                                                </md-input-container>
                                            </md-card-title>
                                            <i class="fa fa-times text-danger" style="cursor:pointer;" (click)="deleteSignature(signature.id)"></i>
                                        </md-card-header>


                                        <md-card-content>
                                            <img src="{{signature.pathToSignatureOnTmp}}" alt="Signature" style="width:100%;height:60px;">
                                        </md-card-content>
                                    </md-card>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
            </md-tab>
        </md-tab-group>
        </div>
    </div>